{% load static %}
<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <title>3D Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>html,body{height:100%;margin:0} #viewer{width:100%;height:100vh}</style>
</head>
<body>
  <div id="viewer"></div>

  <script src="{% static 'ArslanTakipApp/o3dv.min.js' %}"></script>
<script>
  (async function () {
    // 1) get URL from server or query
    var ctxUrl = "{{ file_url|escapejs }}";
    var qsUrl  = new URLSearchParams(window.location.search).get('url');
    var rawUrl = ctxUrl || qsUrl || "";

    // 2) normalize to an absolute URL on the SAME origin and encode path segments
    function toSameOriginUrl(u) {
      // If user passed absolute http(s), keep host but normalize path
      const base = window.location.origin;
      const abs  = new URL(u, base); // handles relative "/media/..."
      // encode each path segment (spaces, Turkish chars)
      abs.pathname = abs.pathname.split('/').map(seg => seg ? encodeURIComponent(decodeURIComponent(seg)) : seg).join('/');
      return abs;
    }

    const u = rawUrl ? toSameOriginUrl(rawUrl) : null;

    const container = document.getElementById('viewer');
    const viewer = new OV.EmbeddedViewer(container, {
      backgroundColor: new OV.RGBAColor(255,255,255,255),
      defaultColor: new OV.RGBColor(200,200,200)
    });

    if (!u) {
      container.innerHTML = '<div style="padding:16px;color:#666">No file URL provided.</div>';
      return;
    }

    // 3) clear diagnostics
    console.log('viewer page:', window.location.href);
    console.log('model url   :', u.href);

    // 4) explicit mixed-content check
    if (window.location.protocol === 'https:' && u.protocol === 'http:') {
      container.innerHTML =
        '<div style="padding:16px;color:#c00">Blocked mixed content: page is HTTPS but file is HTTP.<br>' +
        'Serve /media over HTTPS or open the viewer on HTTP (not recommended).</div>';
      return;
    }

    // 5) test fetch to see exact status
    try {
      const resp = await fetch(u.href, { credentials: 'same-origin' });
      if (!resp.ok) {
        const t = await resp.text().catch(()=> '');
        console.error('Fetch failed:', resp.status, resp.statusText, t.slice(0,200));
        container.innerHTML =
          '<div style="padding:16px;color:#c00">Load failed: ' + resp.status + ' ' + resp.statusText + '</div>';
        return;
      }
    } catch (e) {
      console.error('Fetch error:', e);
      container.innerHTML = '<div style="padding:16px;color:#c00">Network error: ' + e + '</div>';
      return;
    }

    // 6) load into Online3DViewer
    viewer.LoadModelFromUrlList([u.href]);
  })();
</script>

</body>
</html>
